/***
 * Clash Verge Rev å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆæ‡’äººé…ç½®ï¼‰
 * è¿™ä¸ªå…¨å±€è„šæœ¬æ²¡åœ¨ä»£ç†åˆé›†ä¸­æµ‹è¯•è¿‡ï¼ŒæŒ‰é“ç†åº”è¯¥æ˜¯ç”¨ä¸äº†çš„
 * æ—¢ç„¶ç”¨æ‡’äººé…ç½®äº†ï¼Œé‚£è¯·å¥½å¥½å·æ‡’ï¼Œåˆ«é—®å¤ªå¤šä¸ºä»€ä¹ˆ
 * è¿™ä¸ªé…ç½®ä¸»è¦å®ç°çš„åŠŸèƒ½æ˜¯æŒ‰åœ°åŒºåˆ†ç­–ç•¥ç»„ç»„ï¼Œå¹¶ä¸”åœ¨ç»„å†…æ’é™¤é«˜å€ç‡èŠ‚ç‚¹
 * å·²ç»åœ¨é«˜è¾¾ä¸è¶…è¿‡10ä¸ªæœºåœºæµ‹è¯•è¿‡äº†ï¼ˆæ²¡é’±ä¹°æ›´å¤šçš„ï¼‰ï¼Œå…¼å®¹æ€§å¾ˆå¥½ï¼ˆè‡ªæˆ‘æ„Ÿè§‰ï¼‰ï¼Œéƒ½èƒ½å®ç°é¢„æœŸçš„åŠŸèƒ½
 * æœ‰äº›è‡ªå·±è¸©è¿‡å‘çš„åœ°æ–¹éƒ½å·²ç»æ³¨é‡Šäº†ï¼Œå¸Œæœ›æˆ‘çš„ç†è§£æ²¡é”™
 * éƒ¨åˆ†ä»£ç ç¼–å†™éå¸¸æ‹™åŠ£ï¼Œsorr9ry loï½
 */

/**
 * åœ°åŒºé…ç½®ï¼Œé€šè¿‡regexåŒ¹é…ä»£ç†èŠ‚ç‚¹åç§°
 * regexä¼šæœ‰ä¸€å®šæ¦‚ç‡è¯¯åˆ¤ï¼Œè‡ªå·±è°ƒæ•´ä¸€ä¸‹å§
 * excludeHighPercentageæ˜¯æ’é™¤é«˜å€ç‡èŠ‚ç‚¹çš„å¼€å…³ï¼Œåªå¯¹åœ°åŒºåˆ†ç»„æœ‰æ•ˆ
 * å€ç‡å¤§äºregionsé‡Œçš„ratioLimitå€¼çš„ä»£ç†èŠ‚ç‚¹ä¼šè¢«æ’é™¤
 */
const options = {
    excludeHighPercentage: true,
    regions: [{
            name: "HKé¦™æ¸¯",
            regex: /æ¸¯|ğŸ‡­ğŸ‡°|hk|hongkong|hong kong/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/hk.svg",
        },
        {
            name: "USç¾å›½",
            regex: /ç¾|ğŸ‡ºğŸ‡¸|us|united state|america/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/us.svg",
        },
        {
            name: "JPæ—¥æœ¬",
            regex: /æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|jp|japan/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/jp.svg",
        },
        {
            name: "KRéŸ©å›½",
            regex: /éŸ©|ğŸ‡°ğŸ‡·|kr|korea/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/kr.svg",
        },
        {
            name: "SGæ–°åŠ å¡",
            regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|sg|singapore/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/sg.svg",
        },
        {
            name: "CNä¸­å›½å¤§é™†",
            regex: /ä¸­å›½|ğŸ‡¨ğŸ‡³|cn|china/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/cn.svg",
        },
        {
            name: "TWå°æ¹¾çœ",
            regex: /å°æ¹¾|ğŸ‡¨ğŸ‡³|tw|taiwan|tai wan/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/cn.svg",
        },
        {
            name: "GBè‹±å›½",
            regex: /è‹±|ğŸ‡¬ğŸ‡§|uk|united kingdom|great britain/i,
            ratioLimit: 2,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/gb.svg",
        },
    ],
};

/**
 * å…¶å®ä¸¤ç»„DNSå°±å¤Ÿäº†ï¼Œä¸€ç»„å›½å†…ï¼Œä¸€ç»„å›½å¤–
 * defaultDNSæ˜¯ç”¨æ¥è§£æDNSçš„ï¼Œå¿…é¡»ä¸ºIP
 * DNSæœ€å¥½ä¸è¦è¶…è¿‡ä¸¤ä¸ªï¼Œä»ä¸šç•ŒæŸçŸ¥åAPPçš„æ–‡æ¡£é‡Œå­¦çš„
 */
const defaultDNS = ["tls://1.12.12.12", "tls://223.5.5.5"];

const chinaDNS = ["119.29.29.29", "180.184.1.1"];

const foreignDNS = [
    "tls://dns.google",
    "tls://one.one.one.one",
    "tls://dns.quad9.net",
];

/**
 * use-hostsåœ¨è¿™ä¸ªè„šæœ¬é‡Œå¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘å¹¶æ²¡æœ‰è¿›è¡Œç›¸å…³çš„é…ç½®
 * use-system-hostsä¸»è¦æ˜¯æ–¹ä¾¿æˆ‘è‡ªå·±çš„ï¼Œå› ä¸ºæˆ‘ç”µè„‘é‡Œæœ‰è‡ªå·±çš„hosts
 */
const dnsConfig = {
    enable: true,
    listen: ":53",
    ipv6: true,
    "prefer-h3": true,
    "use-hosts": true,
    "use-system-hosts": true,
    "respect-rules": true,
    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",
    "fake-ip-filter": [
        // LAN
        "*.lan",
        "*.localdomain",
        "*.example",
        "*.invalid",
        "*.localhost",
        "*.test",
        "*.local",
        "*.home.arpa",
        /**
         * ä»¥ä¸‹è§„åˆ™æ¥è‡ªClashForAndroidé¡¹ç›®æºä»£ç 
         */
        // Stun Services
        "+.stun.*.*",
        "+.stun.*.*.*",
        "+.stun.*.*.*.*",
        "+.stun.*.*.*.*.*",
        // Google Voices
        "lens.l.google.com",
        // Nintendo Switch
        "*.n.n.srv.nintendo.net",
        // PlayStation
        "+.stun.playstation.net",
        // XBox
        "xbox.*.*.microsoft.com",
        "*.*.xboxlive.com",
        // Microsoft
        "*.msftncsi.com",
        "*.msftconnecttest.com",
        // Bilibili CDN
        "*.mcdn.bilivideo.cn",
    ],
    "default-nameserver": [...defaultDNS],
    nameserver: [...foreignDNS],
    "proxy-server-nameserver": [...foreignDNS],
    /**
     * è¿™é‡Œå¯¹åŸŸåè§£æè¿›è¡Œåˆ†æµ
     * ç”±äºé»˜è®¤dnsæ˜¯å›½å¤–çš„äº†ï¼Œåªéœ€è¦æŠŠå›½å†…ipå’ŒåŸŸååˆ†æµåˆ°å›½å†…dns
     */
    "nameserver-policy": {
        "geoip:private": "system",
        "geoip:cn": chinaDNS,
        "geosite:private": "system",
        "geosite:cn,steam@cn,category-games@cn": chinaDNS,
    },
};

// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = {
    type: "http",
    format: "yaml",
    interval: 86400,
};

// è§„åˆ™é›†é…ç½®
/**
 * å¸¸ç”¨çš„è§„åˆ™é›†å°±æ˜¯loyalsoldierå’Œblackmatrix7
 * è¿™äº›è§„åˆ™é›†èƒ½æå¤§çš„æ–¹ä¾¿æˆ‘ä»¬åšåˆ†æµ
 * ä½†æ˜¯è¿™äº›è§„åˆ™é›†æœ‰å¾ˆå¤šæ˜¯ç›¸äº’ä¹‹é—´æœ‰é‡å çš„ï¼Œä½¿ç”¨å‰æœ€å¥½ä»”ç»†çœ‹çœ‹é‡Œé¢åˆ°åº•æœ‰ä»€ä¹ˆè§„åˆ™
 * è§„åˆ™å¤šäº†è¿è¡Œçš„æ—¶å€™å†…å­˜å ç”¨ä¼šæ˜æ˜¾å¢åŠ 
 */
const ruleProviders = {
    gfw: {
        ...ruleProviderCommon,
        behavior: "domain",
        url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt",
        path: "./ruleset/loyalsoldier/gfw.yaml",
    },
    reject: {
        ...ruleProviderCommon,
        behavior: "domain",
        url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",
        path: "./ruleset/loyalsoldier/reject.yaml",
    },
    download: {
        ...ruleProviderCommon,
        behavior: "classical",
        url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Download/Download.yaml",
        path: "./ruleset/blackmatrix7/download.yaml",
    },
    gamedownload_cn: {
        ...ruleProviderCommon,
        behavior: "classical",
        url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Game/GameDownloadCN/GameDownloadCN.yaml",
        path: "./ruleset/blackmatrix7/gamedownload_cn.yaml",
    },
    gemini: {
        ...ruleProviderCommon,
        behavior: "classical",
        url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Gemini/Gemini.yaml",
        path: "./ruleset/blackmatrix7/gemini.yaml",
    },
    claude: {
        ...ruleProviderCommon,
        behavior: "classical",
        url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Claude/Claude.yaml",
        path: "./ruleset/blackmatrix7/claude.yaml",
    },
};

/**
 * å‰é¢è¯´äº†è§„åˆ™é›†ä¼šæ˜æ˜¾å¢åŠ å†…å­˜å ç”¨æ‰€ä»¥ä¸ªäººæ›´å–œæ¬¢ç”¨GEOæ–‡ä»¶å†…çš„è§„åˆ™
 * ç½‘ä¸Šçš„è§„åˆ™é›†é€‰å‡ ä¸ªè‡ªå·±éœ€è¦çš„ä½œä¸ºè¡¥å……
 * MetaCubeXçš„GEOSITEå…¶å®å·²ç»è¦†ç›–äº†loyalsoldierå’Œblackmatrix7é‡Œé¢æ¯”è¾ƒå¸¸ç”¨çš„è§„åˆ™
 * è§„åˆ™çš„æ’åºç›´æ¥å½±å“åˆ†æµçš„ç»“æœ
 * githubè§„åˆ™é›†å…¶å®åŒ…å«åœ¨microsoftå†…ï¼Œåˆ æ‰ä¹Ÿå¯ä»¥
 * å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨é€»è¾‘è¿ç®—ç¬¦åšæ›´ç²¾ç»†çš„è§„åˆ™
 * åˆ†æµè§„åˆ™ä¸»è¦æœ‰ä¸¤ç§æ–¹å‘ï¼Œå³é»‘åå•æ¨¡å¼å’Œç™½åå•æ¨¡å¼
 * è¿™é‡Œçš„ä¾‹å­å±äºç°åå•æ¨¡å¼
 */
const rules = [
    "RULE-SET,gamedownload_cn,å…¨å±€ç›´è¿",
    "GEOSITE,private,å…¨å±€ç›´è¿",
    "GEOSITE,openai,OpenAI",
    "RULE-SET,gemini,OpenAI",
    "RULE-SET,claude,OpenAI",
    "GEOIP,telegram,ç”µæŠ¥æ¶ˆæ¯",
    "GEOIP,cloudflare,èŠ‚ç‚¹é€‰æ‹©",
    "GEOIP,cloudfront,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,apple,è‹¹æœæœåŠ¡",
    "GEOSITE,github,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,microsoft,å¾®è½¯æœåŠ¡",
    "GEOSITE,youtube,å›½å¤–åª’ä½“",
    "GEOSITE,google,è°·æ­ŒæœåŠ¡",
    "GEOSITE,twitter,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,facebook,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,pixiv,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,category-scholar-!cn,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,biliintl,å›½å¤–åª’ä½“",
    "GEOSITE,netflix,å›½å¤–åª’ä½“",
    "GEOSITE,tiktok,å›½å¤–åª’ä½“",
    "GEOSITE,bahamut,å›½å¤–åª’ä½“",
    "GEOSITE,spotify,å›½å¤–åª’ä½“",
    "GEOSITE,category-games@cn,å…¨å±€ç›´è¿",
    "GEOSITE,category-games@!cn,æ¸¸æˆä¸“ç”¨",
    "GEOSITE,steam@cn,å…¨å±€ç›´è¿",
    "GEOSITE,steam,æ¸¸æˆä¸“ç”¨",
    "GEOSITE,steamunlocked,æ¸¸æˆä¸“ç”¨",
    "GEOSITE,geolocation-!cn,èŠ‚ç‚¹é€‰æ‹©",
    "GEOSITE,gfw,èŠ‚ç‚¹é€‰æ‹©",
    "GEOIP,private,å…¨å±€ç›´è¿,no-resolve",
    "GEOIP,JP,èŠ‚ç‚¹é€‰æ‹©",
    "RULE-SET,gfw,èŠ‚ç‚¹é€‰æ‹©",
    "RULE-SET,download,ä¸‹è½½è½¯ä»¶",
    "GEOSITE,category-ads-all,å¹¿å‘Šè¿‡æ»¤",
    "GEOSITE,tracker,å¹¿å‘Šè¿‡æ»¤",
    "RULE-SET,reject,å…¨å±€æ‹¦æˆª",
    "NOT,((GEOIP,CN)),èŠ‚ç‚¹é€‰æ‹©",
    "MATCH,å…¨å±€ç›´è¿",
];

// ç¨‹åºå…¥å£
/**
 * å…¨å±€è„šæœ¬çš„ä¸»å…¥å£
 * å¯ä»¥ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°profileNameé’ˆå¯¹ç‰¹å®šçš„è®¢é˜…è¿›è¡Œä¸ªæ€§åŒ–è®¾ç½®
 * é‡Œé¢æŸäº›å‚æ•°è®¾ç½®çœ‹ä¸ªäººéœ€æ±‚å¯ä»¥å¢å‡
 */
function main(config) {
    const proxyCount = config?.proxies?.length ?? 0;
    let proxyGroupsRegion = [];
    const proxyProviderCount =
        typeof config?.["proxy-providers"] === "object" ?
        Object.keys(config["proxy-providers"]).length :
        0;
    if (proxyCount === 0 && proxyProviderCount === 0) {
        throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†");
    }

    config["allow-lan"] = true;

    config["bind-address"] = "*";

    /**
     * è¿™ä¸ªä¹Ÿä¼šè¢«cvrè¦†ç›–
     * @type {number}
     */
    config["mixed-port"] = 7890;

    config["mode"] = "rule";

    // è¦†ç›–åŸé…ç½®ä¸­DNSé…ç½®
    config["dns"] = dnsConfig;

    config["profile"] = {
        "store-selected": true,
        "store-fake-ip": true,
    };

    config["unified-delay"] = true;

    config["tcp-concurrent"] = true;

    /**
     * cvrå¯ä»¥åœ¨è®¾ç½®é‡Œè¿›è¡Œé…ç½®
     */
    config["log-level"] = "error";

    /**
     * è¿™ä¸ªå€¼è®¾ç½®å¤§ç‚¹èƒ½çœç”µï¼Œç¬”è®°æœ¬å’Œæ‰‹æœºéœ€è¦å…³æ³¨ä¸€ä¸‹
     */
    config["keep-alive-interval"] = 1800;

    config["find-process-mode"] = "strict";

    /**
     * è¿™ä¸ªå€¼åœ¨cvrä¸­ä¼šè¢«web uiçš„è®¾ç½®è¦†ç›–
     */
    config["external-controller"] = "127.0.0.1:9090";

    config["external-controller-tls"] = "127.0.0.1:9443";

    config["geodata-mode"] = true;

    /**
     * é€‚åˆå°å†…å­˜ç¯å¢ƒï¼Œå¦‚æœåœ¨æ—è·¯ç”±é‡Œè¿è¡Œå¯ä»¥æ”¹æˆstandard
     */
    config["geodata-loader"] = "memconservative";

    config["geo-auto-update"] = true;

    config["geo-update-interval"] = 24;

    /**
     * ç”¨MetaCubeXçš„geoæ–‡ä»¶ï¼Œä¸ªäººæ„Ÿè§‰æ›´æ–°æ¯”è¾ƒé¢‘ç¹ï¼Œæ•°æ®æ¯”è¾ƒå…¨é¢
     */
    config["geox-url"] = {
        geoip: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat",
        geosite: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat",
        mmdb: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb",
    };

    /**
     * ä¸å¼€åŸŸåå—…æ¢çš„è¯ï¼Œæ—¥å¿—é‡Œåªä¼šè®°å½•è¯·æ±‚çš„ipï¼Œå¯¹æŸ¥æ‰¾é—®é¢˜ä¸æ–¹ä¾¿
     * override-destinationé»˜è®¤å€¼æ˜¯trueï¼Œä½†æ˜¯ä¸ªäººå»ºè®®å…¨å±€è®¾ä¸ºfalseï¼Œå¦åˆ™æŸäº›åº”ç”¨ä¼šå‡ºç°è«åå…¶å¦™çš„é—®é¢˜
     * Mijia Cloudè·³è¿‡æ˜¯ç½‘ä¸ŠæŠ„çš„
     */
    config["sniffer"] = {
        enable: true,
        "force-dns-mapping": true,
        "parse-pure-ip": true,
        "override-destination": false,
        sniff: {
            TLS: {
                ports: [443, 8443],
            },
            HTTP: {
                ports: [80, "8080-8880"],
            },
            QUIC: {
                ports: [443, 8443],
            },
        },
        "force-domain": [],
        "skip-domain": [
            "Mijia Cloud",
            "+.oray.com"
        ],
    };

    /**
     * åŒæ­¥èŠ‚ç‚¹æœåŠ¡å™¨çš„æ—¶é—´èƒ½é™ä½è¢«è¯†åˆ«ä¸ºä»£ç†ä¸Šç½‘çš„æ¦‚ç‡ï¼Ÿï¼ˆç„¶å¹¶åµï¼‰
     * å¯ä»¥ä¸è®¾ç½®
     * write-to-systemå¦‚æœè®¾ä¸ºtrueçš„è¯ï¼Œæœ‰å¯èƒ½å‡ºç°ç”µè„‘æ—¶é—´ä¸å¯¹çš„é—®é¢˜
     */
    config["ntp"] = {
        enable: true,
        "write-to-system": false,
        server: "cn.ntp.org.cn",
    };

    /**
     * å¦‚æœé…ç½®æ–‡ä»¶é‡Œæ²¡æœ‰ä»£ç†èŠ‚ç‚¹å°±ç›´æ¥è¿”å›
     */
    if (!config?.proxies) {
        return config;
    }

    // è¦†ç›–åŸé…ç½®ä¸­çš„è§„åˆ™
    config["rule-providers"] = ruleProviders;
    config["rules"] = rules;

    // ä»£ç†ç»„é€šç”¨é…ç½®
    const groupBaseOption = {
        interval: 300,
        timeout: 3000,
        url: "https://www.google.com/generate_204",
        lazy: true,
        "max-failed-times": 3,
        hidden: false,
    };

    /**
     * ä¸‹é¢å°±æ˜¯æ•´ä¸ªè„šæœ¬çš„æ ¸å¿ƒéƒ¨åˆ†äº†ï¼Œå‰æ–¹ä½èƒ½ï¼ï¼ï¼
     */

    ////æˆ‘åŠ çš„
    //const highMultiplierProxies = []; // ç”¨äºå­˜å‚¨é«˜å€ç‡èŠ‚ç‚¹

options.regions.forEach((region) => {
    /**
     * æå–å€ç‡ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
     * åˆ¤æ–­å€ç‡æœ‰é—®é¢˜çš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªæ­£åˆ™çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹
     * è‡ªå·±æ”¹æ­£åˆ™çš„è¯è®°å¾—å¿…é¡»æŠŠå€ç‡çš„numberå€¼æå–å‡ºæ¥
     */
    let proxies = config.proxies
        .filter((a) => {
            const multiplier =
                /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i.exec(
                    a.name,
                )?.[1];
            const parsedMultiplier = parseFloat(multiplier || "0");

            // å¦‚æœå€ç‡é«˜äº region.ratioLimitï¼Œåˆ™åŠ å…¥åˆ°é«˜å€ç‡èŠ‚ç‚¹æ•°ç»„
            if (parsedMultiplier > region.ratioLimit) {
                highMultiplierProxies.push(a.name);
            }

            return (
                a.name.match(region.regex) &&
                parsedMultiplier <= region.ratioLimit
            );
        })
        .map((b) => {
            return b.name;
        });

    /**
     * å¿…é¡»å†åˆ¤æ–­ä¸€ä¸‹æœ‰æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
     * æ²¡æœ‰çš„è¯ï¼Œè¿™ä¸ªç­–ç•¥ç»„å°±ä¸åº”è¯¥å­˜åœ¨
     * æˆ‘å–œæ¬¢è‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹ï¼Œå–œæ¬¢è½®è¯¢çš„å¯ä»¥è‡ªå·±ä¿®æ”¹
     */
    if (proxies.length > 0) {
        proxyGroupsRegion.push({
            ...groupBaseOption,
            name: region.name,
            type: "url-test",
            tolerance: 100,
            icon: region.icon,
            proxies: proxies,
        });
    }
});
    /////////////

    // options.regions.forEach((region) => {
    //     /**
    //      * æå–å€ç‡ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
    //      * åˆ¤æ–­å€ç‡æœ‰é—®é¢˜çš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªæ­£åˆ™çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹
    //      * è‡ªå·±æ”¹æ­£åˆ™çš„è¯è®°å¾—å¿…é¡»æŠŠå€ç‡çš„numberå€¼æå–å‡ºæ¥
    //      */
    //     let proxies = config.proxies
    //         .filter((a) => {
    //             const multiplier =
    //                 /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i.exec(
    //                     a.name,
    //                 )?.[1];
    //             return (
    //                 a.name.match(region.regex) &&
    //                 parseFloat(multiplier || "0") <= region.ratioLimit
    //             );
    //         })
    //         .map((b) => {
    //             return b.name;
    //         });

    //     /**
    //      * å¿…é¡»å†åˆ¤æ–­ä¸€ä¸‹æœ‰æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
    //      * æ²¡æœ‰çš„è¯ï¼Œè¿™ä¸ªç­–ç•¥ç»„å°±ä¸åº”è¯¥å­˜åœ¨
    //      * æˆ‘å–œæ¬¢è‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹ï¼Œå–œæ¬¢è½®è¯¢çš„å¯ä»¥è‡ªå·±ä¿®æ”¹
    //      */
    //     if (proxies.length > 0) {
    //         proxyGroupsRegion.push({
    //             ...groupBaseOption,
    //             name: region.name,
    //             type: "url-test",
    //             tolerance: 100,
    //             icon: region.icon,
    //             proxies: proxies,
    //         });
    //     }
    // });

    /**
     * å½“åœ°åŒºç­–ç•¥ç»„å­˜åœ¨æ˜¯ï¼Œå†å»ºç«‹ä¸€ä¸ªåœ°åŒºé€‰æ‹©çš„ç­–ç•¥ç»„
     * ç±»å‹ä¸ºæ‰‹åŠ¨é€‰æ‹©ï¼Œæ–¹ä¾¿åˆ‡æ¢åœ°åŒº
     */
    if (proxyGroupsRegion.length > 0) {
        proxyGroupsRegion = [{
                ...groupBaseOption,
                name: "åœ°åŒºé€‰æ‹©",
                type: "select",
                proxies: proxyGroupsRegion.map((item) => {
                    return item.name;
                }),
                icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/un.svg",
            },
            ...proxyGroupsRegion,
        ];
    }

    /**
     * è¦†ç›–åŸé…ç½®ä¸­çš„ä»£ç†ç»„
     * ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šinclude-allï¼Ÿæˆ‘å–œæ¬¢ï¼
     * å›½å¤–åª’ä½“ã€è°·æ­ŒæœåŠ¡ä»€ä¹ˆçš„å¯ä»¥è‡ªå·±æ ¹æ®å–œå¥½è°ƒæ•´ï¼Œè®°å¾—åŒæ—¶è°ƒæ•´åˆ†æµè§„åˆ™
     * æŠŠå…¨å±€åœ°åŒºé€‰æ‹©å’Œåœ°åŒºç­–ç•¥ç»„éƒ½æ’åˆ°å›½å¤–åª’ä½“ç­‰ç­–ç•¥ç»„é‡Œï¼Œèƒ½è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†æµ
     * åˆ«å«Œéº»çƒ¦ï¼Œç­–ç•¥ç»„å¯ä»¥äº’ç›¸å¥—ç”¨æ˜¯clash metaï¼ˆmihomoï¼‰å¼ºå¤§çš„å–ç‚¹ä¹‹ä¸€
     * å…¨å±€æ‹¦æˆªä¾ç„¶ä¿ç•™äº†èŠ‚ç‚¹é€‰æ‹©ï¼Œä¸‡ä¸€æŸå¤©æ‰‹è´±æƒ³çœ‹çœ‹æ‹¦æˆªäº†ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ
     * å…¨å±€ç›´è¿ä¹Ÿä¿ç•™äº†èŠ‚ç‚¹é€‰æ‹©ï¼ŒåŒæ ·æ˜¯ä¸ºäº†é¢„é˜²è‡ªå·±æ‰‹è´±
     */
    config["proxy-groups"] = [{
            ...groupBaseOption,
            name: "èŠ‚ç‚¹é€‰æ‹©",
            type: "select",
            proxies: [
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg",
        },
        {
            ...groupBaseOption,
            name: "å»¶è¿Ÿé€‰ä¼˜",
            type: "url-test",
            tolerance: 100,
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg",
            ////////æˆ‘åŠ çš„
            "url": "http://www.gstatic.com/generate_204", // æµ‹è¯•å»¶è¿Ÿç”¨çš„ URL
            "interval": 300, // æ¯300ç§’é‡æ–°æµ‹è¯•ä¸€æ¬¡
            /////////
        },
        {
            ...groupBaseOption,
            name: "æ•…éšœè½¬ç§»",
            type: "fallback",
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/ambulance.svg",
        },
        {
            ...groupBaseOption,
            name: "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
            type: "load-balance",
            strategy: "consistent-hashing",
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/merry_go.svg",
        },
        {
            ...groupBaseOption,
            name: "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
            type: "load-balance",
            strategy: "round-robin",
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/balance.svg",
        },
        /**
         * åœ°åŒºé€‰æ‹©åœ¨è¿™é‡Œæ’å…¥
         */
        ...proxyGroupsRegion,
        {
            ...groupBaseOption,
            name: "å›½å¤–åª’ä½“",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            url: "https://i.ytimg.com/generate_204",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg",
        },
        {
            ...groupBaseOption,
            name: "ç”µæŠ¥æ¶ˆæ¯",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            url: "https://www.telegram.org/img/website_icon.svg",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg",
        },
        {
            ...groupBaseOption,
            name: "æ¸¸æˆä¸“ç”¨",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/steam.svg",
        },
        {
            ...groupBaseOption,
            name: "ä¸‹è½½è½¯ä»¶",
            type: "select",
            proxies: [
                "DIRECT",
                "REJECT",
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/app_store.svg",
        },
        {
            ...groupBaseOption,
            "expected-status": "200",
            name: "OpenAI",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            url: "https://cdn.oaistatic.com/_next/static/media/favicon-32x32.630a2b99.png",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg",
        },
        {
            ...groupBaseOption,
            name: "è°·æ­ŒæœåŠ¡",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg",
        },
        {
            ...groupBaseOption,
            name: "å¾®è½¯æœåŠ¡",
            type: "select",
            proxies: [
                "å…¨å±€ç›´è¿",
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            url: "https://logincdn.msauth.net/shared/5/images/microsoft_logo_ee5c8d9fb6248c938fd0.svg",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/microsoft.svg",
        },
        {
            ...groupBaseOption,
            name: "è‹¹æœæœåŠ¡",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            url: "https://www.icloud.com/system/icloud.com/2420Hotfix12/favicon-16x16.png",
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/apple.svg",
        },
        {
            ...groupBaseOption,
            name: "å¹¿å‘Šè¿‡æ»¤",
            type: "select",
            proxies: ["REJECT", "DIRECT", "èŠ‚ç‚¹é€‰æ‹©"],
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/bug.svg",
        },
        {
            ...groupBaseOption,
            name: "å…¨å±€ç›´è¿",
            type: "select",
            proxies: [
                "DIRECT",
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                ...proxyGroupsRegion.map((value) => {
                    return value.name;
                }),
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg",
        },
        {
            ...groupBaseOption,
            name: "å…¨å±€æ‹¦æˆª",
            type: "select",
            proxies: ["REJECT", "DIRECT", "èŠ‚ç‚¹é€‰æ‹©"],
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/block.svg",
        },
        {
            ...groupBaseOption,
            name: "æ¼ç½‘ä¹‹é±¼",
            type: "select",
            proxies: [
                "èŠ‚ç‚¹é€‰æ‹©",
                "å»¶è¿Ÿé€‰ä¼˜",
                "æ•…éšœè½¬ç§»",
                "è´Ÿè½½å‡è¡¡(æ•£åˆ—)",
                "è´Ÿè½½å‡è¡¡(è½®è¯¢)",
                "å…¨å±€ç›´è¿",
            ],
            "include-all": true,
            icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg",
        },
//         /////æˆ‘åŠ çš„
//     {
//     ...groupBaseOption,
//     name: "é«˜å€ç‡èŠ‚ç‚¹",
//     type: "select",
//     proxies: highMultiplierProxies, // å°†é«˜å€ç‡èŠ‚ç‚¹æ·»åŠ åˆ°è¿™ä¸ªç­–ç•¥ç»„
//     "include-all": false, // ä¸åŒ…æ‹¬å…¶ä»–èŠ‚ç‚¹
//     icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/high_cost.svg", // è‡ªå®šä¹‰å›¾æ ‡
// }
    ///////////////

    ];

    // è¿”å›ä¿®æ”¹åçš„é…ç½®
    return config;
}
